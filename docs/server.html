<!DOCTYPE html>  <html> <head>   <title>server.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="cli.html">                 cli.coffee               </a>                                           <a class="source" href="defaultargs.html">                 defaultargs.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Set export objects for node and coffee to a function that generates a server.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports = exports = </span><span class="nf">(argv) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>Dependencies</h1>

<p>anything not in the standard library is included in the repo, or
can be installed with an:
    npm install</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">express     = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;express&#39;</span><span class="p">)</span>
  <span class="nv">path        = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span>
  <span class="nv">url         = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;url&#39;</span><span class="p">)</span>
  <span class="nv">hbs         = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;hbs&#39;</span><span class="p">)</span>
  <span class="nv">fs          = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;fs&#39;</span><span class="p">)</span> <span class="c1"># Just to load jQuery</span>
  <span class="nv">Q           = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;q&#39;</span><span class="p">)</span>  <span class="c1"># Promises, promises</span>
  <span class="nv">AdmZip      = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;adm-zip&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Authentication machinery</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">passport    = </span><span class="k">new</span> <span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;passport&#39;</span><span class="p">)).</span><span class="nx">Passport</span><span class="p">()</span>
  <span class="nv">OpenIDstrat = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;passport-openid&#39;</span><span class="p">).</span><span class="nx">Strategy</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Local util objects/functions. See <a href="util.html">util.coffee</a></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">Promise     = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./util&#39;</span><span class="p">).</span><span class="nx">Promise</span>
  <span class="nv">remoteGet   = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./util&#39;</span><span class="p">).</span><span class="nx">remoteGet</span>
  <span class="nv">asyncDeposit = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./util&#39;</span><span class="p">).</span><span class="nx">asyncDeposit</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>State</h2>

<p>Stores state in-memory in these arrays</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">content = </span><span class="p">[]</span>
  <span class="nv">resources   = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./util&#39;</span><span class="p">).</span><span class="nx">resources</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Create the main application object, app.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">app = </span><span class="nx">express</span><span class="p">.</span><span class="nx">createServer</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>bodyParser in connect 2.x uses node-formidable to parse
the multipart form data.
Used for getting Zips deposited via POST</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><code>defaultargs.coffee</code> exports a function that takes
the argv object that is passed in and then does its
best to supply sane defaults for any arguments that are missing.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">argv = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./defaultargs&#39;</span><span class="p">)(</span><span class="nx">argv</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Stores new content and returns the new id</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">newContent = </span><span class="nf">(promise) -&gt;</span>
    <span class="nv">id = </span><span class="nx">content</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">content</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span> <span class="nv">users: </span><span class="p">[],</span> <span class="nv">versions: </span><span class="p">[</span> <span class="nx">promise</span> <span class="p">]</span> <span class="p">}</span>
    <span class="nx">id</span>
  <span class="nv">newContentVersion = </span><span class="nf">(id, promise, users) -&gt;</span>
    <span class="nv">resource = </span><span class="nx">content</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
    <span class="nv">ver = </span><span class="nx">resource</span><span class="p">.</span><span class="nx">versions</span><span class="p">.</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>If updating content and not changing the set of allowed users
Just use the previous set of users</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">users</span><span class="o">?</span>
      <span class="nv">resource.users = </span><span class="nx">users</span>
    <span class="nx">resource</span><span class="p">.</span><span class="nx">versions</span><span class="p">.</span><span class="nx">push</span> <span class="nx">promise</span>
    <span class="nx">ver</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Checks if a given user can modify a given piece of content</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">canChangeContent = </span><span class="nf">(id, user) -&gt;</span>
    <span class="nv">resource = </span><span class="nx">content</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">resource</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">user</span> <span class="o">&gt;=</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h3>Authentication Functions</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>For requests that need to be authenticated, add this into the pipe
by the owner, and returns 403 if someone else tries.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">authenticated = </span><span class="nf">(req, res, next) -&gt;</span>
    <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">()</span> <span class="o">or</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">x</span>
      <span class="nx">next</span><span class="p">()</span>
    <span class="k">else</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s">&#39;Access Forbidden&#39;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Simplest possible way to serialize and deserialize a user. (to store in a session)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">passport</span><span class="p">.</span><span class="nx">serializeUser</span><span class="p">(</span> <span class="nf">(user, done) -&gt;</span>
    <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
  <span class="p">)</span>
  <span class="nx">passport</span><span class="p">.</span><span class="nx">deserializeUser</span><span class="p">(</span> <span class="nf">(id, done) -&gt;</span>
    <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">id</span><span class="p">})</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Tell passport to use the OpenID strategy.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenIDstrat</span><span class="p">({</span>
    <span class="nv">returnURL: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">argv</span><span class="p">.</span><span class="nx">u</span><span class="si">}</span><span class="s">/login/openid&quot;</span>
    <span class="nv">realm: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">argv</span><span class="p">.</span><span class="nx">u</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">identifierField: </span><span class="s">&#39;identifier&#39;</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nf">(id, done) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Authenticated as </span><span class="si">#{</span> <span class="nx">id</span> <span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">debug</span>
    <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">id</span><span class="p">})</span>
  <span class="p">)))</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h2>Express configuration</h2>

<p>Set up all the standard express server options,
including hbs to use handlebars/mustache templates
saved with a .html extension, and no layout.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span> <span class="o">-&gt;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s">&#39;views&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;/views&#39;</span><span class="p">))</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s">&#39;view engine&#39;</span><span class="p">,</span> <span class="s">&#39;hbs&#39;</span><span class="p">)</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s">&#39;.html&#39;</span><span class="p">,</span> <span class="nx">hbs</span><span class="p">)</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s">&#39;view options&#39;</span><span class="p">,</span> <span class="nv">layout: </span><span class="kc">false</span><span class="p">)</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">cookieParser</span><span class="p">())</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">())</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">methodOverride</span><span class="p">())</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">({</span> <span class="nv">secret: </span><span class="s">&#39;notsecret&#39;</span><span class="p">}))</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">initialize</span><span class="p">())</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">session</span><span class="p">())</span> <span class="c1"># Must occur after express.session()</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">router</span><span class="p">)</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">static</span><span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">c</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Load static files from node_modules (bootstrap, jquery, Aloha, ...)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;/node_modules&#39;</span><span class="p">)))</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h2>Set up standard environments.</h2>

<p>In dev mode turn on console.log debugging as well as showing the stack on err.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="s">&#39;development&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">errorHandler</span><span class="p">({</span> <span class="nv">dumpExceptions: </span><span class="kc">true</span><span class="p">,</span> <span class="nv">showStack: </span><span class="kc">true</span> <span class="p">}))</span>
    <span class="nv">argv.debug = </span><span class="nx">console</span><span class="o">?</span> <span class="o">and</span> <span class="kc">true</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Show all of the options a server is using.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">argv</span> <span class="k">if</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Swallow errors when in production.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="s">&#39;production&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">errorHandler</span><span class="p">())</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h3>Routes</h3>

<p>Routes currently make up the bulk of the Express
server. Most routes use literal names,
or regexes to match, and then access req.params directly.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h2>Admin Page</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s">&#39;admin.html&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="c1"># {} is vars</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h2>POST routes</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>The prefix for "published" content (ie "/content/1234")</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">CONTENT = </span><span class="s">&#39;content&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h2>Deposit Content</h2>

<p>Deposit either a new piece of content (>=1) or new versions of existing content</p>

<p>The minimum information that needs to be conveyed is:
1. The payload (zip)
2. For each piece of content whether it's a new piece of content or updating
    an existing piece of content
3. How to find each piece of content</p>

<p>'deposit' is my way of implementing the PUBLISH/SAVE features of the unpub/pub repos.</p>

<p>This can be any URL (for federation)
It can also be several URLs.
Each query parameter is either an id (in which case it's an update) or "new" in which case it's new content</p>

<p>Structure of the POST parameters:</p>

<ul>
<li><code>'archive'</code> = BINARY-ZIP-FILE : We're getting a zip file.
            If there are no other POST parameters then
            create new content from all the HTML files in the zip
            (ie EPUB import).</li>
<li>ID = VALUE : This tells the deposit where to get the content (VALUE)
          and what to do with it (ID)</li>
</ul>

<p>Possible ID's:</p>

<ul>
<li><code>'new'</code> : The content doesn't have an id yet so deposit will create one</li>
<li>UUID  : This piece of published content is being updated.
      If the authenticated user has permissions to change this content
      then update it. Otherwise return an publish error.</li>
</ul>

<p>Possible VALUEs:</p>

<ul>
<li>URL   : A full URL to pull content from (this is the 'pull' API)</li>
<li>HREF  : A path to an HTML file in the ZIP ('push' API)</li>
<li>HTML_TEXT : The raw HTML to use
        (this is so the edit repo API is the same as the published repo API)</li>
</ul>

<p>Example POST parameters:</p>

<pre><code> archive : BINARY_DATA
 'col01' : 'toc.html'
 'm1234' : 'chapters/ch1.html'
 'm5678' : 'chapters/ch2.html'
 new     : 'chapters/ch3.html'
 new     : 'chapters/ch4.html'
</code></pre>

<hr />

<p>Some remote examples (these can be in the same POST)</p>

<pre><code> 'm9003' : 'http://editor.cnx.org/content/2k3jh'
 new     : 'http://editor.cnx.org/content/9283y'
</code></pre>

<hr />

<p>Sending the HTML directly (think 'saving'; can also be in same POST)</p>

<pre><code> new     : '&lt;html&gt;&lt;body&gt;Hello World&lt;/body&gt;&lt;/html&gt;'
 '2k3jh' : '&lt;html&gt;&lt;body&gt;Hello Cruel World&lt;/body&gt;&lt;/html&gt;'
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s">&#39;/deposit&#39;</span><span class="p">,</span> <span class="nx">authenticated</span><span class="p">,</span> <span class="nf">(req, res, next) -&gt;</span>
    <span class="nv">HTML_FILE_NAME = </span><span class="sr">/\.x?html?$/</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h2>Start figuring out what content we have and if we have permission to update it</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>First make sure the user has permission to change all the content that is being updated</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">postParams = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class="o">or</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nx">id</span> <span class="k">of</span> <span class="nx">postParams</span>
      <span class="k">if</span> <span class="s">&#39;archive&#39;</span> <span class="o">!=</span> <span class="nx">id</span> <span class="o">and</span> <span class="s">&#39;new&#39;</span> <span class="o">!=</span> <span class="nx">id</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">canChangeContent</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="s">&quot;ERROR: You do not have permission to change </span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <h2> Build dictionary of content to deposit</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Next we need to build a dictionary of {id -> how-to-get-the-content}
This is used by the renaming pass to convert local paths (in the zip) to the
published id's.
During this phase new content is given a fresh id.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">class</span> <span class="nx">HrefLookup</span>
      <span class="nv">constructor: </span><span class="o">-&gt;</span>
        <span class="vi">@map = </span><span class="p">{}</span>
      <span class="nv">isEmpty: </span><span class="nf">() -&gt;</span> <span class="nx">@map</span> <span class="o">?</span> <span class="kc">true</span><span class="o">:</span> <span class="kc">false</span>
      <span class="nv">has: </span><span class="nf">(key) -&gt;</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">@map</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>A way to iterate over all the content</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">each: </span><span class="nf">(iterator) -&gt;</span>
        <span class="k">for</span> <span class="nx">href</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@map</span>
          <span class="nx">iterator</span><span class="p">(</span><span class="nx">href</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Put a new piece of content in
Creates a new id if it is new content
Creates a new version if it is updating existing content</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">put: </span><span class="nf">(href, id=null) -&gt;</span>
        <span class="nv">promise = </span><span class="k">new</span> <span class="nx">Promise</span><span class="p">()</span>
        <span class="k">if</span> <span class="kc">null</span> <span class="o">==</span> <span class="nx">id</span>
          <span class="nv">id = </span><span class="nx">newContent</span><span class="p">(</span><span class="nx">promise</span><span class="p">)</span>
          <span class="nv">ver = </span><span class="mi">0</span>
        <span class="k">else</span>
          <span class="nv">ver = </span><span class="nx">newContentVersion</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span>
        <span class="nx">@map</span><span class="p">[</span><span class="nx">href</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nv">id: </span><span class="nx">id</span><span class="p">,</span> <span class="nv">ver: </span><span class="nx">ver</span><span class="p">,</span> <span class="nv">promise: </span><span class="nx">promise</span> <span class="p">}</span>
      <span class="nv">getId: </span>     <span class="nf">(href) -&gt;</span> <span class="nx">@map</span><span class="p">[</span><span class="nx">href</span><span class="p">].</span><span class="nx">id</span>
      <span class="nv">getVer: </span>    <span class="nf">(href) -&gt;</span> <span class="nx">@map</span><span class="p">[</span><span class="nx">href</span><span class="p">].</span><span class="nx">ver</span>
      <span class="nv">getPromise: </span><span class="nf">(href) -&gt;</span> <span class="nx">@map</span><span class="p">[</span><span class="nx">href</span><span class="p">].</span><span class="nx">promise</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Populate the hrefLookup object using the POST parameters</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">hrefLookup = </span><span class="k">new</span> <span class="nx">HrefLookup</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">hrefs</span> <span class="k">of</span> <span class="nx">postParams</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>hrefs could either be a string or an array of strings (if id='new')</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Either it's new content or it's a new version of existing content</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">id</span> <span class="o">==</span> <span class="s">&#39;new&#39;</span>
        <span class="k">if</span> <span class="nx">hrefs</span> <span class="o">not</span> <span class="k">instanceof</span> <span class="nb">Array</span>
          <span class="nv">hrefs = </span><span class="p">[</span> <span class="nx">hrefs</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>For each piece of new content deposit it and get back the id</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="nx">href</span> <span class="k">in</span> <span class="nx">hrefs</span>
          <span class="k">if</span> <span class="nx">href</span> <span class="c1"># Each of these URL&#39;s could be the empty string. If so, ignore it</span>
            <span class="nx">hrefLookup</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">href</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">hrefs</span> <span class="k">instanceof</span> <span class="nb">Array</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&#39;Cannot update the same content more than once in a single deposit&#39;</span><span class="p">)</span>
        <span class="nv">href = </span><span class="nx">hrefs</span>
        <span class="nx">hrefLookup</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">href</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>If an archive was provided then open it up</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">hasArchive = </span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span> <span class="o">and</span> <span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="s">&#39;archive&#39;</span><span class="p">]</span> <span class="o">and</span> <span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="s">&#39;archive&#39;</span><span class="p">].</span><span class="nx">size</span>
    <span class="nv">archiveZip = </span><span class="kc">null</span>
    <span class="k">if</span> <span class="nx">hasArchive</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Received file named </span><span class="si">#{</span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="s">&#39;archive&#39;</span><span class="p">].</span><span class="nx">name</span><span class="si">}</span><span class="s"> with size </span><span class="si">#{</span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="s">&#39;archive&#39;</span><span class="p">].</span><span class="nx">size</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nv">archiveZip = </span><span class="k">new</span> <span class="nx">AdmZip</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="s">&#39;archive&#39;</span><span class="p">].</span><span class="nx">path</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>If an archive is sent and no POST parameters were specified then just include
all HTML files in the archive</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">hrefLookup</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
        <span class="k">for</span> <span class="nx">entry</span> <span class="k">in</span> <span class="nx">archiveZip</span><span class="p">.</span><span class="nx">getEntries</span><span class="p">()</span>
          <span class="k">continue</span> <span class="k">if</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span> <span class="c1"># Skip hidden files</span>
          <span class="k">if</span> <span class="nx">HTML_FILE_NAME</span><span class="p">.</span><span class="nx">test</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">name</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;No URLs specified, adding HTML file from Zip named </span><span class="si">#{</span><span class="nx">entry</span><span class="p">.</span><span class="nx">entryName</span><span class="si">}</span><span class="s">&quot;</span>
            <span class="nx">hrefLookup</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">entryName</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <h2>Done preparing (that's all we can do synchronously)</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Fire off a worker and return the list of id's and versions
so the user can monitor the progress of publishing their set of content</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">setTimeout</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">asyncDeposit</span><span class="p">(</span><span class="nx">argv</span><span class="p">,</span> <span class="nx">hrefLookup</span><span class="p">,</span> <span class="nx">archiveZip</span><span class="p">)),</span> <span class="mi">10</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Return a mapping of uploaded URL/hrefs to content URLs</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">ret = </span><span class="p">{}</span>
    <span class="nx">hrefLookup</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(href, value) -&gt;</span>
      <span class="nv">id = </span><span class="nx">value</span><span class="p">.</span><span class="nx">id</span>
      <span class="nv">ver = </span><span class="nx">value</span><span class="p">.</span><span class="nx">ver</span>
      <span class="nx">ret</span><span class="p">[</span><span class="nx">href</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;/</span><span class="si">#{</span><span class="nx">CONTENT</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s">@</span><span class="si">#{</span><span class="nx">ver</span><span class="si">}</span><span class="s">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Return a href -> id@ver dictionary of everything submitted
Shortcut if only 1 piece of content was sent</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">ret</span><span class="p">).</span><span class="nx">length</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">ret</span><span class="p">[</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">ret</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">else</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span>
  <span class="p">)</span> <span class="c1"># END app.post(&#39;/deposit&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Return JSON of all the content in the repo</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;/</span><span class="si">#{</span><span class="nx">CONTENT</span><span class="si">}</span><span class="s">/&quot;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Build up a little map of all the promises (tasks)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">tasks = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">c</span> <span class="k">in</span> <span class="nx">content</span>
      <span class="nv">promise = </span><span class="nx">c</span><span class="p">.</span><span class="nx">versions</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">versions</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">push</span>
        <span class="nv">history: </span> <span class="nx">promise</span><span class="p">.</span><span class="nx">history</span>
        <span class="nv">created: </span> <span class="nx">promise</span><span class="p">.</span><span class="nx">created</span>
        <span class="nv">modified: </span><span class="nx">promise</span><span class="p">.</span><span class="nx">modified</span>
        <span class="nv">status: </span>  <span class="nx">promise</span><span class="p">.</span><span class="nx">status</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">tasks</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Return a single piece of content</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;/</span><span class="si">#{</span><span class="nx">CONTENT</span><span class="si">}</span><span class="s">/:id([0-9]+)(@:ver([0-9]+))?&quot;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
    <span class="nv">id = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
    <span class="nv">ver = </span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s">&#39;ver&#39;</span><span class="p">,</span> <span class="s">&quot;@</span><span class="si">#{</span><span class="nx">content</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">versions</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="nv">ver = </span><span class="nx">ver</span><span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">ver</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="c1"># split off the &#39;@&#39; character</span>
    <span class="nv">body = </span><span class="nx">content</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">versions</span><span class="p">[</span><span class="nx">ver</span><span class="p">]</span> <span class="c1"># .body is a Promise</span>
    <span class="nx">body</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Return metadata for a single piece of content</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;/</span><span class="si">#{</span><span class="nx">CONTENT</span><span class="si">}</span><span class="s">/:id([0-9]+)(@:ver([0-9]+))?.json&quot;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
    <span class="nv">id = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
    <span class="nv">ver = </span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s">&#39;ver&#39;</span><span class="p">,</span> <span class="s">&quot;@</span><span class="si">#{</span><span class="nx">content</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="nv">ver = </span><span class="nx">ver</span><span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">ver</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="c1"># split off the &#39;@&#39; character</span>
    <span class="nv">body = </span><span class="nx">content</span><span class="p">[</span><span class="nx">id</span><span class="p">][</span><span class="nx">ver</span><span class="p">].</span><span class="nx">body</span> <span class="c1"># .body is a Promise</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Return imported resource like an image or CSS</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;/resource/:id([0-9]+)&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Set the mimetype for the resource</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">id = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Getting resource id=&quot;</span> <span class="o">+</span> <span class="nx">id</span>
    <span class="nv">resource = </span><span class="nx">resources</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="nx">resource</span><span class="p">.</span><span class="nx">contentType</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">resource</span><span class="p">.</span><span class="nx">content</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <h3>Routes for OpenID authentication</h3>

<p>Redirect to oops when login fails.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s">&#39;/login&#39;</span><span class="p">,</span>
    <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s">&#39;openid&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nv">failureRedirect: </span><span class="s">&#39;/error&#39;</span><span class="p">}),</span>
    <span class="nf">(req, res) -&gt;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">)</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Route that the openID provider redirects user to after login.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;/login/openid&#39;</span><span class="p">,</span>
    <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s">&#39;openid&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nv">failureRedirect: </span><span class="s">&#39;/error&#39;</span><span class="p">}),</span>
    <span class="nf">(req, res) -&gt;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">)</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Logout when /logout is hit with any http method.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s">&#39;/logout&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">logout</span><span class="p">()</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">)</span>
  <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <h2>Start the server</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">p</span><span class="p">,</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">o</span> <span class="k">if</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">o</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>When server is listening emit a ready event.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">emit</span> <span class="s">&quot;ready&quot;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&quot;Server listening in mode: </span><span class="si">#{</span><span class="nx">app</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">env</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Return app when called, so that it can be watched for events and shutdown with .close() externally.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 